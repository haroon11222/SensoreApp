@model SensoreApp.Controllers.DashboardViewModel

@{
    ViewData["Title"] = "My Sensore Dashboard";
}

<style>
    /* CSS for the 32x32 Heatmap Grid */
    .heatmap-grid {
        display: grid;
        grid-template-columns: repeat(32, 1fr); 
        grid-template-rows: repeat(32, 1fr);   
        width: 100%;
        aspect-ratio: 1 / 1; 
        border: 1px solid #ddd;
        margin: auto;
        max-width: 400px; 
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .grid-cell {
        min-height: 0;
        min-width: 0;
        border: none;
        transition: background-color 0.1s;
    }
    .color-legend {
        list-style: none;
        padding: 0;
        margin-top: 1rem;
        font-size: 0.8rem;
    }
    .color-legend li {
        display: inline-block;
        margin-right: 15px;
    }
    .legend-color-box {
        display: inline-block;
        width: 15px;
        height: 15px;
        margin-right: 5px;
        border: 1px solid #ccc;
    }
</style>

<div class="container-fluid py-5">
    <div class="row">
        <div class="col">
            <h1>Welcome, @Model.PatientName</h1>
            <p class="lead">Your real-time pressure data from the Sensore mat.</p>
        </div>
    </div>
    <hr />

    @if (!string.IsNullOrEmpty(Model.FeedbackMessage))
    {
        <div class="alert alert-success">@Model.FeedbackMessage</div>
    }
    @if (!string.IsNullOrEmpty(Model.FeedbackError))
    {
        <div class="alert alert-danger">@Model.FeedbackError</div>
    }

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4 shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Real-Time Pressure Map (Heatmap)</h5>
                </div>
                <div class="card-body text-center p-3">
                    <div id="heatmapContainer" class="heatmap-grid">
                        </div>
                    
                    <ul class="color-legend">
                        <li><span class="legend-color-box" style="background-color: #440154;"></span> Low Pressure</li>
                        <li><span class="legend-color-box" style="background-color: #21908d;"></span> Normal Pressure</li>
                        <li><span class="legend-color-box" style="background-color: #fde725;"></span> High Pressure</li>
                    </ul>

                    <div class="mt-3">
                        <label for="timelineScrubber" class="form-label">Review Previous Data (Timeline Scrubber):</label>
                        <input type="range" class="form-range" id="timelineScrubber" min="0" max="100" value="100">
                    </div>
                </div>
            </div>
            
            <div class="alert alert-@(Model.AlertStatus == "OK" ? "success" : "danger") shadow-sm" role="alert">
                **Current Alert Status:** @Model.AlertStatus
                @if (Model.AlertStatus != "OK")
                {
                    <p class="mb-0">Your pressure distribution requires attention. Please adjust your position.</p>
                }
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4 shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Key Metrics</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        **Peak Pressure Index** (Highest Recorded Pressure)
                        <span id="peakPressureIndex" class="badge bg-primary rounded-pill">-- / 255</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        **Contact Area %** (Sensor Coverage)
                        <span id="contactArea" class="badge bg-primary rounded-pill">-- %</span>
                    </li>
                </ul>
            </div>

            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Submit Feedback (Flag Risk Region)</h5>
                </div>
                <div class="card-body">
                    <form asp-controller="Patient" asp-action="SubmitFeedback" method="post">
                        <p class="card-text text-muted">
                            Flag a specific time or area for your clinician to review.
                        </p>
                        <div class="mb-3">
                            <textarea name="userComment" class="form-control" rows="3" placeholder="E.g., I feel numbness in the left hip region at this time."></textarea>
                        </div>
                        <button type="submit" class="btn btn-secondary w-100">Submit Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Key Metrics Trend Over Time</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group mb-3" role="group">
                        <button type="button" class="btn btn-outline-secondary active">Last Hour</button>
                        <button type="button" class="btn btn-outline-secondary">Last 6 Hours</button>
                        <button type="button" class="btn btn-outline-secondary">Last 24 Hours</button>
                    </div>
                    <div style="height: 350px; position: relative;">
                        <canvas id="historicalChart"></canvas>
                    </div>
                    <small class="text-muted d-block mt-2">Graphs of Peak Pressure Index and Contact Area % over the selected period.</small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    // --- C# Data passed to JavaScript ---
    // This resolves the compilation error (CS1503) by ensuring a string is always passed.
    const pressureMatrix = @Html.Raw(Model.PressureDataJson ?? "[]"); 
    const historicalData = @Html.Raw(Model.HistoricalDataJson ?? "[]"); 
    const GRID_SIZE = 32;

    // =========================================================================
    // 1. HEATMAP RENDERING LOGIC (The "Heatmap File" content)
    // =========================================================================
    function getColor(value) {
        // Simple Viridis-like color scale (Low value is purple/blue, High value is yellow)
        const normalized = (value - 1) / 254; 
        
        if (normalized < 0.5) {
            const r = Math.floor(10 + 200 * normalized);
            const g = Math.floor(255 * normalized);
            const b = Math.floor(255 - 200 * normalized);
            return `rgb(${r}, ${g}, ${b})`;
        } else {
            const r = 255;
            const g = Math.floor(255 * (1 - (normalized - 0.5) * 2));
            const b = Math.floor(50 * (1 - normalized));
            return `rgb(${r}, ${g}, ${b})`;
        }
    }

    function renderHeatmap() {
        const container = document.getElementById('heatmapContainer');
        container.innerHTML = ''; 
        
        let maxPressure = 0;
        let contactAreaCount = 0;
        const LOWER_THRESHOLD = 50; 

        if (!pressureMatrix || pressureMatrix.length === 0) return;

        for (let row = 0; row < GRID_SIZE; row++) {
            const rowData = pressureMatrix[row];
            if (!rowData) continue; 
            
            for (let col = 0; col < GRID_SIZE; col++) {
                const pressureValue = rowData[col];
                
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.style.backgroundColor = getColor(pressureValue);
                
                container.appendChild(cell);

                // Calculate Metrics
                if (pressureValue > LOWER_THRESHOLD) {
                    contactAreaCount++;
                }
                if (pressureValue > maxPressure) {
                    maxPressure = pressureValue;
                }
            }
        }
        
        // Update Key Metrics Display
        document.getElementById('peakPressureIndex').innerText = `${maxPressure} / 255`;
        const totalPixels = GRID_SIZE * GRID_SIZE; 
        const contactAreaPercentage = ((contactAreaCount / totalPixels) * 100).toFixed(1);
        document.getElementById('contactArea').innerText = `${contactAreaPercentage} %`;
    }


    // =========================================================================
    // 2. HISTORICAL GRAPH RENDERING (Chart.js)
    // =========================================================================
    
    let chartInstance = null; 

    function renderHistoricalChart() {
        const ctx = document.getElementById('historicalChart').getContext('2d');
        
        if (!historicalData || historicalData.length === 0) return;

        const labels = historicalData.map(d => new Date(d.Timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
        const ppiData = historicalData.map(d => d.PeakPressureIndex);
        const contactData = historicalData.map(d => d.ContactAreaPercentage);

        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Peak Pressure Index (PPI)',
                        data: ppiData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        yAxisID: 'y',
                        tension: 0.2
                    },
                    {
                        label: 'Contact Area %',
                        data: contactData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        yAxisID: 'y1',
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                stacked: false,
                scales: {
                    x: { title: { display: true, text: 'Time' } },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'PPI (Max 255)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'Contact Area %' },
                        max: 100
                    }
                }
            }
        });
    }

    // Initialize rendering when the page is loaded
    document.addEventListener('DOMContentLoaded', () => {
        renderHeatmap();
        renderHistoricalChart();
    });

</script>
}